---
title: "Making an Air Pollution Map with leaflet"
author: "Alice Tivarovsky"
date: "06/25/2022"
toc: true
slug: leaflet_pollution
categories:
  - geospatial data
  - data visualization
  - public health
tags:
  - geospatial data
  - data visualization
  - public health
---

Notes: 
- potential data source: https://data.cdc.gov/Environmental-Health-Toxicology/Daily-PM2-5-Concentrations-All-County-2001-2016/7vdq-ztk9
- use this to download and unzip
- 

## Motivation 

## Background 

## Data Preparation

## Analysis

## Conclusion

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Motivation

These days, it seems like there is an ever-growing list of massive, complicated issues to worry about - between climate change, nuclear war, mega-droughts, wildfires. Reading the news feels like an exercise in adding to that list. 

But sometimes, the news gives us a bright spot. My home state of California - a place, which was once home to some of the worst air pollution in the world, recently passed a [resolution](https://www.reuters.com/business/autos-transportation/tesla-says-california-should-toughen-ev-requirements-2022-08-25/) to eliminate gasoline-powered cars by 2035. I was modestly excited by this, but I was more interested in the current air pollution situation. Since I don't think about air pollution all that much, I ended up in a rabbit-hole of unstructured research. How bad is air pollution now? How does my state, city, and county compare to others in the US? Is air pollution getting better or worse? 

I will attempt to answer some of those questions below. Of course, others have already done that, and probably in a more compelling manner. But going through the process myself was fun, and if you want to learn a bit about geospatial data and `leaflet`, I think an exercise like this is highly useful.  

## Background

- Leaflet walktrough, show how to map health data
- The definitive guide to R `leaflet` is found [here](https://rstudio.github.io/leaflet/)

Other stuff: 
Globally, [over 6 million](https://ourworldindata.org/air-pollution) people die each year as a result of air pollution. It's not something we think much about in the United States or other parts of the developed world (aside from, maybe, complaining about the [smog in Los Angeles](https://www.latimes.com/local/la-me-air-pollution-0428-pictures-photogallery.html)), but it's a leading cause of death in parts of Africa and Asia. And unfortunately, it seems to be getting worse in other parts of the world.  

Although [progress](https://ourworldindata.org/grapher/death-rates-from-air-pollution) has been made through better policy and environmental regulation, this magnitude of premature deaths should surely attract more attention than it does now. [Some](https://www.bloomberg.com/opinion/articles/2021-03-10/air-pollution-kills-far-more-people-than-covid-ever-will#xj4y7vzkg) have posed plausible reasons for the public's lack of interest (mainly that it's an "over there" problem). [Others](https://www.thelancet.com/journals/lanplh/article/PIIS2542-5196(22)00090-0/fulltext) have scolded countries for not doing more to protect public health. 

- spatial data = two types
  - raster aka bitmap: grid of pixels in various colors (eg a jpeg or gif)
  - vector: composed of paths, no pixels, smoother

- explain PM 2.5


## Data Preparation

```{r libraries}

library(tidyverse)
library(readxl)
library(leaflet)
library(rgdal) # Geospatial data abstraction library
library(stats)

```

In the United States, the EPA maintains tens of thousands of outdoor air quality monitors and provides data to the public through several sources, including the AirData [website](https://www.epa.gov/outdoor-air-quality-data). First, we'll practice mapping skills by pinning all these  monitors on a map. The geo-locations for all active monitors were downloaded [here](https://aqs.epa.gov/aqsweb/airdata/download_files.html#Meta). We read in the data, call `leaflet`, add tiles, and center on a point in the middle of the country. 
```{r map air quality sites}
sites <- read.csv("./data/aqs_sites 3.csv", header = TRUE)

# Choose coordinates in middle of country
naked_map <- 
  leaflet() %>% 
  setView(lng = -95, lat = 40, zoom = 4)  %>% 
  addTiles() 

naked_map

```

It never fails to amaze me how little code it takes to make a map. Next, we'll pass the `sites` object (EPA refers to the location monitors as sites) to leaflet and visualize them as markers on the map. 
```{r site circle markers}

sites_map <- 
  leaflet(sites) %>% 
  setView(lng = -95, lat = 40, zoom = 4)  %>% 
  addTiles() %>% 
  addCircleMarkers(lat = ~Latitude, 
                   lng = ~Longitude, 
                   radius = 1)

sites_map

```

Most states look like blue blobs, but we can zoom in and find the ones in our neighborhood (unless, of course, we live in the middle of Nevada).


## Analysis

Now let's get a sense of what those monitors are measuring.

As someone not well-versed in environmental pollutants, figuring out what dataset and which measures to use was a bit complicated. Two common measures are [PM 2.5](https://www.epa.gov/pm-pollution/particulate-matter-pm-basics) (particulate matter 2.5 micrometers or smaller in diameter) and ground level [ozone](https://www.epa.gov/ground-level-ozone-pollution/ground-level-ozone-basics#wwh). 

But a more general metric, one which combines these and other toxic pollutants, is the [Air Quality Index (AQI)](https://www.airnow.gov/aqi/aqi-basics/). Even if you're not terribly concerned about air pollution, you've probably seen AQI measures before, possibly through your weather app telling you the air quality is bad so close your windows and don't even think about leaving your house. Or perhaps you've seen a local alert or warning to that effect.[^1] 

Given its ubiquity, and the fact that it's a more general metric than PM 2.5, ground level ozone, or any other specific particulate, I decided to look at AQI. More specifically, we'll be looking at annual median AQI by county. State-level measures are too large for air pollution data, and city level is likely too small. I'll be comparing 2021 data to 2013 (the years were chosen arbitrarily). We'll load the data and look at a snapshot. 

```{r load aqi data}

# annual 'concentration by monitor' dataset for 2021
full_2021 <- 
  read.csv("./data/annual_aqi_by_county_2021.csv", header = TRUE) %>% 
  janitor::clean_names() 

head(full_2021)

full_2013 <- 
  read.csv("./data/annual_aqi_by_county_2013.csv", header = TRUE) %>% 
  janitor::clean_names()

head(full_2013)

```


Now we need to figure out how to present the AQI data visually - one way might be to color the marker representing each monitor in accordance with the level of pollution it measured for some time interval. But given the high concentration of dots, it might be hard to read. Instead, let's try to divide the United States by county lines. The intent of this approach is to mimic what the Washington Post used in this 2019 [article](https://www.washingtonpost.com/business/2019/10/23/air-pollution-is-getting-worse-data-show-more-people-are-dying/), where it reported an excess of 10,000 deaths due to air pollution over a 2-year period. 

To do this, we'll need county shapefiles- geo-spatial boundary files that will trace the shape of each county - which will comprise a layer over our bare leaflet map. The Census Bureau maintains shapefiles in accordance with current county boundaries, and the ones used below were found [here](https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html).

Reading these shapefiles into R requires the the `rgdal` library and the `readOGR` function. 

__Let's start with a subset of states, just to play around and get a feel for how it works. Note that the shapefiles refer to states and counties by their Federal Information Processing System (FIPS) codes, but it's easy to look up [conversions](https://transition.fcc.gov/oet/info/maps/census/fips/fips.txt).__ 


```{r shapefiles}

# Source for shapefiles: https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html
counties <- 
  readOGR("cb_2018_us_county_5m", layer = "cb_2018_us_county_5m", GDAL1_integer64_policy = TRUE)

some_states <- subset(counties, counties$STATEFP %in% c('06', '39', '40'))

leaflet(counties) %>% 
  setView(lng = -95, lat = 40, zoom = 4)  %>% 
  addTiles() %>% 
  addPolygons(weight = 0.1, smoothFactor = 0.5,  opacity = 1.0, fillOpacity = 0.2)

```

The shapefiles are working well - we can see well-defined state and county borders, overlaid nicely on top of the map. But what we want is a map, like the one above, but color-coded according to the value of the selected parameter - in our case, the median annual AQI. In map-speak, this is called a chloropleth, and in order to make one, we need to give `leaflet` the following things: 
* A color palette
* A numeric vector defining "bins" (i.e cutoff points at which one color in the palette will change to the next)

Since we don't yet know the range of values for median AQI, let's run some descriptive statistics on it.  

```{r find median AQI}

# 2013 data
range(full_2013$median_aqi)
quantile(full_2013$median_aqi)

# 2021 data
range(full_2021$median_aqi)
quantile(full_2021$median_aqi)


```

Without any calculations or data visualization, we can already see that 2021 maximum is much higher than 2013. But let's press on, now that we have a general sense of the spread of AQI. 

```{r chloropleth}
bins <- c(0, 20, 40, 60, 80, 100, 120, 140)
pal <- colorBin("OrRd", domain = full_2013$median_aqi, bins = bins)

```

And now, we get to the somewhat tricky part of the process. We need to combine the shapefile object `counties` with the 2013 and 2021 air pollution datasets stored in `full_2013` and `full_2021`. This seems impossible since we're combining a geospatial object with a standard dataset, but it turns out to be pretty simple. 

```{r }

full_2013_1 <- 
  full_2013 %>% 
  select(county, median_aqi) %>% 
  rename("NAME" = county)

counties <- merge(counties, full_2013_1, by = "NAME", duplicateGeoms = TRUE)


leaflet(counties) %>% 
  setView(lng = -95, lat = 40, zoom = 4)  %>% 
  addTiles() %>% 
  addPolygons(weight = 0.1, smoothFactor = 0.5,  opacity = 1.0, fillOpacity = 0.2, fillColor = ~pal(counties$median_aqi))


```


## Conclusion


## References

- https://sesync-ci.github.io/maps-in-R-lesson/2016/09/14/#/slides/shinyleaflet
- https://aqs.epa.gov/aqsweb/airdata/download_files.html#Annual (Air Quality datasets); used Annual Concentration by Monitor

[^1] Here in Los Angeles, we see them frequently during fire season.  
---
title: "Adding Buttons to plotly Plots"
author: "Alice Tivarovsky"
date: "2022-09-18"
toc: true
slug: plotly-buttons
output: blogdown::html_page
tags:
  - R
  - Data Visualization
  - Epidemiology
  - Covid
categories:
  - R
  - Data Visualization
  - Epidemiology
  - Covid  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE, 
  fig.align = "center", 
  out.width = "100%"
  )

```

## Motivation

I recently found myself drafting some `plotly` figures for work, and I wanted to add a bit more interactivity without creating a `shiny` app. I plotted time-series data and I wanted the end user to be able to subset the plot to a year of their choosing, or to see the entire range of time on one figure.

After a bit of googling around, I found a few solutions, but [this one](https://plotly.com/r/custom-buttons/) suited my needs the best. These buttons are straight-forward for the user and pretty simple to code up. Below is a quick demo. 


## Data Preparation

```{r libraries}
library(tidyverse)
library(plotly)

```

We'll be using Covid-19 case data in the United States, downloaded from [Our World in Data](https://ourworldindata.org/explorers/coronavirus-data-explorer?facet=none&Metric=Confirmed+cases&Interval=7-day+rolling+average&Relative+to+Population=true&Color+by+test+positivity=false&country=~USA). 

```{r load data}
raw_data <- 
  read.csv("./data/owid-covid-data.csv", header = TRUE) 

head(raw_data)

```

Next, we'll limit to United States data points, and select only the necessary columns. We'll also fix the `date` variable to date, and add a new categorical variable for the year, which will become the basis of our buttons. 

```{r clean data}

us_df <- 
  raw_data %>% 
  select(location, date, new_cases, new_cases_smoothed) %>% 
  filter(location == "United States") %>% 
  mutate(date = as.Date(date), 
         year = case_when('2020-01-01'>= date & date < '2021-01-01' ~ "2020", 
                          '2021-01-01'>= date & date < '2022-01-01' ~ "2021", 
                          '2022-01-01'>= date & date < '2023-01-01' ~ 2022)
         )

head(us_df)

rm(raw_data)

```

## Analysis

Now we'll plot a regular `plotly` figure as a "before" shot. 

```{r regular plot}

us_df %>% 
  plot_ly(x = ~date) %>% 
  add_lines(y = ~new_cases) %>% 
  add_lines(y = ~new_cases_smoothed)

```


```{r plot with buttons}

us_df %>% 
  plot_ly(x = ~date) %>% 
  add_lines(y = ~ new_cases) %>% 
  add_lines(y = ~new_cases_smoothed) %>% 
  layout(
    title = "Plotly Buttons", 
    updatemenus = list(
      list(type = "buttons", 
           buttons = list(
             list(method = "restyle", 
                  args = list("year", 2020), 
                  label = "2020"), 
             list(method = "resyle", 
                  args = list("year", 2021), 
                  label = "2021"), 
             list(method = "restyle", 
                  args = list("year", 2022), 
                  label = "2022")
             )
           ))
    )
  

```

## Conclusion

I hope this walk-through inspired you to play with `leaflet` on your own. I said it before, but I never cease to be amazed by the capabilities of interactive packages in R, and `leaflet` is as nice as they get. Please don't hesitate to contact me if you have any questions or suggestions. Happy mapping!

## References

- https://sesync-ci.github.io/maps-in-R-lesson/2016/09/14/#/slides/shinyleaflet
- https://aqs.epa.gov/aqsweb/airdata/download_files.html#Annual (Air Quality datasets); used Annual Concentration by Monitor

[^1]: Here in Los Angeles, we see them frequently during fire season.  